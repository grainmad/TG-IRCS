
# TG-IRCS
![](tg-ircs.jpg)
使用Telegram机器人通过MQTT服务器与esp8266单片机通信，实现功能：
- 复制红外线，并持久化于闪存
- 定时定期定量执行红外指令
- 终止定时任务
- 可多用户使用Telegram机器人指令，需管理员认证
- 定期检测断网重连，更新网络时间
- 机器人支持多设备控制

# 机器人指令

## 学习红外指令  
执行`copy`命令后，单片机将亮灯一段时间，这段时间内存储收到的最后一条红外指令。

`/copy name [old]`
- `name`  
    - 学习红外指令的名称，非空，且只能包含数字、字母、下划线、减号
    - 若`old`未指定
        - `name`已存在则更新`name`
        - `name`已存在则从剩余容量中分配，容量已满则轮转覆盖。
- `old`  
    - 替换旧命令，单片机校验旧命令不存在则执行失败  
    - 默认 `""`

## 查看学习到的红外指令  
可以看到保存的指令名称

`/cmdlist`  

## 执行红外指令
可定时定期定量执行多条红外命令

`/exec name [start] [freq] [remain]`
- `name`  
    - 执行命令，单片机校验不存在则执行失败
    - 多条命令以逗号分割，然后命令会顺序执行
- `start`  
    - 指定执行开始时间，格式：
        - [Unix 时间戳](https://zh.wikipedia.org/wiki/UNIX%E6%97%B6%E9%97%B4)  
        - 指定日期`%Y-%m-%d/%H:%M:%S`  e.g. `2025-01-08/12:30:00`  
        - 延时时间`?d?h?m?s` e.g. `1d2h3m4s` 1天2时3分4秒后执行  
    - 小于当前时间则立即执行并更新为当前时间  
    - 默认 `0`
- `freq`  
    - 执行频率，格式：
        - 非负整数，单位秒  
        - 模式`?d?h?m?s` e.g. `1d2h3m4s` 每隔1天2时3分4秒执行
    - 默认 `0`
- `remain`  
    - 剩余执行次数  
    - 默认 `1`
    

## 任务队列信息
对于延期执行的命令，将在队列中存储

`/tasklist`  
- 当前所有任务信息，包括任务id，下次执行的时间，执行周期，剩余执行次数，当剩余执行次数为0时结束任务。

## 终止任务
可通过任务的编号终止任务队列中的某些任务

`/terminate id [...]`  
- 终止数字编号为id的任务，支持多个id，以任意非数字字符分割

## 管理和执行别名
有时需要多条命令才能达到想要的效果，命令又多又长。可以用较短的别名来组织管理。

`/preference`
- 偏好设置，可管理和执行别名，通过别名可以批量执行exec类型指令。
  ``` text
  /preference [name]
  [+addname]
  cmd
  ...
  [-delname]
  ```
    - `name` 执行别名，多个以空格分割，必须与`/preference`同一行
    - `addname` 添加别名，必须以`+`开头标识，接下来的行将识别为`exec`命令的参数。
    - `delname` 删除别名，必须以`-`开头标识
    - 支持多别名删除与添加
- 使用示例：
  ``` text
  /preference alias1
  +alias1
  cmd1
  cmd2
  -alias2
  ```
  添加别名`alias1`，`alias1`包含了`cmd1`和`cmd2`两条指令。  
  删除别名`alias2`，如果存在的话。  
  返回当前的别名列表。  
  最后执行别名alias1的命令序列。

## 设备列表
有多个单片机设备，可以展示这些设备，或者切换到某台设备。被选中的设备名称会以`+`开头标识。

`/device [name]`
- 展示设备列表
- `name`  指定切换设备名称

## 添加新用户
其他用户可能想要使用机器人，只需提供该用户的id即可为用户授权，管理员可能想要踢出某些用户。

`/usermod [[+]id] [-id]`  
- 添加或删除用户的数字id，多个id用非数字字符分割
- 纯数字或`+`开头为添加用户
- `-`开头为删除用户

## 申请使用机器人
其他用户执行此指令，管理员可为其授权。

`/auth`  
- 向管理员认证，申请使用指令，管理员会收到用户数字id



# 部署
## 机器人部署
### 环境
* 梯子
* `Python 3.12.4`
### 步骤

**配置环境变量**
```shell
cp env.json.template env.json
```
修改`env.json`内配置  
- `ir_bot_token` TG找机器人[@BotFather](https://t.me/BotFather)创建机器人，然后生成。
- `ir_admin_chat_id` 管理员TG用户的id，你的id可通过机器人[@userinfobot](https://t.me/userinfobot)获取。或者先不填，在本机器人运行后输入任意指令可在控制台找到。  
- 配置设备列表参数
    - `name` 设备名称
    - `ir_mqtthost` MQTT服务器
    - `ir_mqttport` MQTT服务器端口
    - `ir_sub_topic` MQTT消息发布主题，对应单片机上的订阅主题
    - `ir_pub_topic` MQTT消息订阅主题，对应单片机上的发布主题
    - `ir_username` MQTT用户名
    - `ir_password` MQTT密码


**下载依赖**
``` shell
pip -r requirements.txt
```
**运行机器人**   
~~请确保控制台有梯子~~
``` shell
python tg.py
```

## esp8266部署
### 环境
* esp8266NodeMCU单片机
* Arduino IDE
### 步骤

1. 编译烧录
2. 配置WiFi和MQTT参数  
    - 设备启动时自动配网  
    如果设备保存了之前的 WiFi 信息且能成功连接到 WiFi，则跳过 AP 模式，直接运行程序。否则启动 AP 模式
    - 设备运行时主动配网  
    在设备运行中按下FLASH键，启动AP模式配网。
    - AP模式配网
    设备会开启一个热点（默认 SSID 为 `ESP8266_AP`，密码为 `12345678`）。连接到热点后，访问 `192.168.4.1` 打开配置页面。在配置页面中:
        - 选择附近的WiFi网络，并输入对应密码。
        - 输入对应的MQTT服务器参数，默认值从闪存中加载，修改后会保存到闪存，输入空值视为默认值。
    - 在设备运行中断开WiFi，将定期尝试重连之前的WiFi。  
3. 指示灯说明
    - 启动时长亮LED，此时自动连接上次的WIFI，连接成功会闪烁4下，如果一直长亮（超过30秒）说明进入了AP模式配网。在AP模式配网后，连接成功会闪烁4下，否则设备重启。
    - 按下FLASH键长亮LED，此时进入了AP模式配网。在AP模式配网后，连接成功会闪烁4下，连接失败**不会重启**设备。
    - 指令`/copy` LED会亮起10秒，此期间接收的红外指令保留最后一条。
    - MQTT服务器断连会闪烁1下，WIFI断连会闪烁2下。